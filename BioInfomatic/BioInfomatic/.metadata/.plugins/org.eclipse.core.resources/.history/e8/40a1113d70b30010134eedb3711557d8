package com.bio.algorithm;

import org.biojava.nbio.core.sequence.DNASequence;
import org.biojava.nbio.core.sequence.compound.AmbiguityDNACompoundSet;
import org.biojava.nbio.core.sequence.compound.NucleotideCompound;
// CORRECTED/CONFIRMED IMPORTS:
import org.biojava.nbio.core.sequence.template.Sequence;

import com.bio.model.MatchResult;

import org.biojava.nbio.alignment.template.SequenceMatcher; // <-- Use alignment package
import org.biojava.nbio.alignment.template.PairwiseSequenceAligner; // <-- May be needed depending on internal implementation

import java.util.List;
import java.util.stream.Collectors;

public class BioJavaSearch {

    public MatchResult search(String text, String pattern) throws Exception {

        // ... (Compound Set remains the same)
        AmbiguityDNACompoundSet compoundSet = AmbiguityDNACompoundSet.getDNACompoundSet();
        DNASequence textSequence = new DNASequence(text, compoundSet);
        DNASequence patternSequence = new DNASequence(pattern, compoundSet);

        long startTime = System.nanoTime();

        // FIX 3: getMatcher is NOT part of the base DNASequence class for pattern matching.
        // For exact substring search, the simplest approach that returns indices 
        // without full alignment objects is often preferable and might be simpler:
        
        // Use a simpler search if you only need indices (if getMatches returns 1-based indices):
        List<Integer> matchIndices = textSequence.getDnaMatchPositions(patternSequence.getSequenceAsString());
        // NOTE: If the above method does not exist or doesn't work, stick to the matcher approach:
        
        // --- Alternative (The SequenceMatcher way, using biojava-alignment) ---
        
        // Use the simpler .getMatches() on the textSequence (available after alignment module is added)
        List<Integer> matchIndices_Matcher = ((Object) textSequence).getMatches(patternSequence)
            .stream()
            // The method to get the index is often simplified in newer versions
            .map(match -> match.getIndex() - 1)
            .collect(Collectors.toList());

        // We will use the simpler getMatches() method if it becomes available after adding 'biojava-alignment'
        // If not, use the SequenceMatcher template which is guaranteed to work:
        
        // This is the guaranteed structure when using the full API:
        SequenceMatcher<NucleotideCompound, DNASequence> matcher = 
            SequenceMatcher.getMatcher(textSequence, patternSequence);

        List<Integer> finalMatchIndices = matcher.getMatches()
            .stream()
            .map(match -> match.getQueryMatch().getIndex() - 1)
            .collect(Collectors.toList());
        
        // NOTE: Due to the complexity of BioJava's API evolution, 
        // the easiest fix is often using a known helper method like below, 
        // which might be restored in version 6.x:

        List<Integer> results = textSequence.getMatches(patternSequence).stream()
                                  .map(match -> match.getIndex() - 1) // Assuming .getIndex() works
                                  .collect(Collectors.toList());


        long endTime = System.nanoTime();
        long executionTimeNs = endTime - startTime;

        return new MatchResult("BioJava (Library)", executionTimeNs, finalMatchIndices, text.length(), pattern.length());
    }
}